name: Helm Chart CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'charts/**'
      - '.github/workflows/helm-lint.yaml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'charts/**'
      - '.github/workflows/helm-lint.yaml'

jobs:
  lint:
    name: Lint Helm Charts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Add Helm repositories
        run: |
          helm repo add stable https://charts.helm.sh/stable
          helm repo update

      - name: Lint Helm charts
        run: |
          for chart in charts/*/; do
            echo "Linting chart: $chart"
            helm lint "$chart"
          done

      - name: Template Helm charts
        run: |
          for chart in charts/*/; do
            chart_name=$(basename "$chart")
            echo "Templating chart: $chart_name"
            helm template test-release "$chart" --debug
          done

  test:
    name: Test Helm Charts
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Create kind cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: test-cluster
          config: kind/kind-config.yaml

      - name: Wait for cluster to be ready
        run: |
          kubectl wait --for=condition=Ready nodes --all --timeout=300s
          kubectl cluster-info

      - name: Test chart installation
        run: |
          for chart in charts/*/; do
            chart_name=$(basename "$chart")
            echo "Testing installation of chart: $chart_name"
            helm install test-release "$chart" --wait --timeout 5m
            helm test test-release || true
            helm uninstall test-release
          done

  validate-values:
    name: Validate Values Files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Validate example values files
        run: |
          for chart in charts/*/; do
            chart_name=$(basename "$chart")
            echo "Validating values files for: $chart_name"

            # Test with default values
            helm template test-release "$chart" > /dev/null

            # Test with example values if they exist
            for values_file in examples/values-*.yaml; do
              if [ -f "$values_file" ]; then
                echo "Testing with values file: $values_file"
                helm template test-release "$chart" -f "$values_file" > /dev/null
              fi
            done
          done
